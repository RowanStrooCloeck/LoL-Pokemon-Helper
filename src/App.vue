<template>
  <div class="header">
    <input placeholder="Summoner Name" v-model="summonerName" @change="getData" />
    <div v-if="isLoading">
      <span class="loader"></span>
    </div>

    <div v-else-if="!isLoading">
      Not loading
    </div>
  </div>

  <div>
    <VueMultiselect v-model="multiValue" :options="all" :multiple="true" :close-on-select="false"
      placeholder="Pick some" label="name" track-by="name" />
  </div>

  <div class="aram-content">
    <template v-for="selection in multiValue">
      <div :id="selection.name" class="champion">
        <img :src="getLoadingIcon(selection.name)" :alt="selection.name" />
        <h2>{{ selection.name }}</h2>
        <div class="mastery-points">
          <h4>Mastery Points</h4>
          <p>{{ getLocaleNumberString(selection.masteryPoints) }}</p>
        </div>
        <div class="next-milestone">
          <h4>Next Milestone</h4>
          <p>{{ getNextMilestone(selection.masteryPoints) }}</p>
        </div>
      </div>
    </template>
  </div>

  <!-- 100k and above -->
  <TierList :tierIcon="getTierIconUrl('NotFound')" :data="tieredData.grandmaster" 
    description="100k and above" :amount="tieredData.grandmaster.length" />

  <!-- 99.999 to 50.000 -->
  <TierList :tierIcon="getTierIconUrl('Master')" :data="tieredData.master"
    description="100k to 50k" :amount="masterAmount" />

  <!-- 49.999 to 10.000 -->
  <TierList :tierIcon="getTierIconUrl('Diamond')" :data="tieredData.diamond"
    description="50k to 10k" :amount="diamondAmount" />

  <!-- 9.999 to 5.000 -->
  <TierList :tierIcon="getTierIconUrl('Platinum')" :data="tieredData.platinum"
    description="10k to 5k" :amount="platinumAmount" />

  <!-- 4.999 to 1.000 -->
  <TierList :tierIcon="getTierIconUrl('Gold')" :data="tieredData.gold"
    description="5k to 1k" :amount="goldAmount" />

  <!-- 999 to 500 -->
  <TierList :tierIcon="getTierIconUrl('Silver')" :data="tieredData.silver"
    description="1k to 500" :amount="silverAmount" />

  <!-- 499 to 100 -->
  <TierList :tierIcon="getTierIconUrl('Bronze')" :data="tieredData.bronze"
    description="500 to 100" :amount="bronzeAmount" />

  <!-- 99 and below -->
  <TierList :tierIcon="getTierIconUrl('Iron')" :data="tieredData.iron"
    description="Below 100" :amount="ironAmount" />
</template>

<script lang="ts">
import axios from "axios";
import { Vue, Options } from "vue-class-component";
import VueMultiselect from "vue-multiselect";
import type { LolDataObject } from "./assets/LolDataObject";
import type { TieredLolDataObjects } from "./assets/TieredLolDataObjects";
import { TierIconUrl } from "./assets/TierIconUrl";
import TierList from "./components/TierList.vue";

@Options({
  components: {
    TierList,
    VueMultiselect
  }
})

export default class App extends Vue {
  private baseUrl: string = 'http://localhost:3000';
  private imageUrl: string = 'http://ddragon.leagueoflegends.com/cdn/13.3.1/img/champion';
  public summonerName: string = '';
  public isLoading: boolean = false;
  public multiValue: LolDataObject[] = [];

  public all: LolDataObject[] = [];
  public amount: number = 150;
  public tieredData: TieredLolDataObjects = {
    grandmaster: [],
    master: [],
    diamond: [],
    platinum: [],
    gold: [],
    silver: [],
    bronze: [],
    iron: []
};

  mounted() {
    this.summonerName = "shimomeikato";
    this.getData();
  }

  public async getData() {
    this.isLoading = true;
    this.resetData();
    await axios.get(`${this.baseUrl}/champion-mastery/euw1/${this.summonerName}`).then(res => {
      if (res) {
        this.isLoading = false;
        this.all = res.data.slice();
        res.data.sort((a: { masteryPoints: number; }, b: { masteryPoints: number; }) => (a.masteryPoints > b.masteryPoints ? -1 : 1));
        this.setTierData(res.data);
      }
    }).catch(err => {
      this.isLoading = false;
      // show error on screen
    });
  }

  public clearSearch() {
    this.multiValue = [];
  }

  public getTierIconUrl(tier: string) {
    return (<any>TierIconUrl)[tier];
  }

  public getLoadingIcon(name: string) {
    return `${this.imageUrl}/${name}.png`
  }

  public getLocaleNumberString(value: number) {    
    // @ts-ignore
    return value.toLocaleString(this.locale)
  }

  public get masterAmount(): number {
    return this.tieredData.grandmaster.length + this.tieredData.master.length;
  }

  public get diamondAmount(): number {
    return this.masterAmount + this.tieredData.diamond.length;
  }

  public get platinumAmount(): number {
    return this.diamondAmount + this.tieredData.platinum.length;
  }

  public get goldAmount(): number {
    return this.platinumAmount + this.tieredData.gold.length;
  }

  public get silverAmount(): number {
    return this.goldAmount + this.tieredData.silver.length;
  }

  public get bronzeAmount(): number {
    return this.silverAmount + this.tieredData.bronze.length;
  }

  public get ironAmount(): number {
    return this.bronzeAmount + this.tieredData.iron.length;
  }

  public resetData() {
      this.tieredData = {
      grandmaster: [],
      master: [],
      diamond: [],
      platinum: [],
      gold: [],
      silver: [],
      bronze: [],
      iron: []
    };
  }

  public setTierData(data: LolDataObject[]) {
    data.forEach(champ => {
      if (champ.masteryPoints >= 100000) {
        this.tieredData.grandmaster.push(champ);
      } else if (champ.masteryPoints >= 50000) {
        this.tieredData.master.push(champ);
      } else if (champ.masteryPoints >= 10000) {
        this.tieredData.diamond.push(champ);
      } else if (champ.masteryPoints >= 5000) {
        this.tieredData.platinum.push(champ);
      } else if (champ.masteryPoints >= 1000) {
        this.tieredData.gold.push(champ);
      } else if (champ.masteryPoints >= 500) {
        this.tieredData.silver.push(champ);
      } else if (champ.masteryPoints >= 100) {
        this.tieredData.bronze.push(champ);
      } else {
        this.tieredData.iron.push(champ);
      }
    });
  }

  public getNextMilestone(value: number) {
    switch (true) {
      case (value < 100):
        return 100;
      case (value < 500):
        return 500;
      case (value < 1000):
        return this.getLocaleNumberString(1000);
      case (value < 5000):
        return this.getLocaleNumberString(5000);
      case (value < 10000):
        return this.getLocaleNumberString(10000);
      case (value < 50000):
        return this.getLocaleNumberString(50000);
      case (value < 100000):
        return this.getLocaleNumberString(100000);
      default:
        return 0;
    }
  }
}
</script>

<style scoped>
header {
  line-height: 1.5;
}

@media (min-width: 1024px) {
  header {
    display: flex;
    place-items: center;
    padding-right: calc(var(--section-gap) / 2);
  }
}

.aram-content {
  display: flex;
}

.champion {
  display: flex;
  flex-direction: column;
}
</style>